<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD de Música</title>
    <link rel="stylesheet" href="../public/Styless.css/crud.css"> <!-- Asegúrate de tener este archivo CSS -->
</head>
<body>
    <div class="container">
        <h1>Gestión de Música</h1>
        
        <div class="button-container">
            <button id="createButton">Crear</button>
            <button id="updateButton">Modificar</button>
            <button id="deleteButton">Eliminar</button>
            <button id="exitButton">Salir</button>
        </div>

        <div id="formContainer" class="form-container" style="display: none;">
            <form id="crudForm">
                <input type="hidden" id="musicId">
                <label for="artist">Artista:</label>
                <input type="text" id="artist" placeholder="Nombre del Artista" required>

                <label for="genre">Género:</label>
                <input type="text" id="genre" placeholder="Género Musical" required>

                <label for="year">Año:</label>
                <input type="date" id="year" required>

                <button type="submit">Guardar Cambios</button>
            </form>
        </div>

        <div id="message"></div> <!-- Para mostrar mensajes al usuario -->

        <!-- Tabla para mostrar los datos -->
        <h2>Resultados de Búsqueda</h2>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Artista</th>
                    <th>Álbum</th>
                    <th>Género</th>
                    <th>URL de Vista Previa</th>
                    <th>Fecha de Creación</th>
                    <th>Fecha de Actualización</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <!-- Los resultados se llenarán aquí -->
            </tbody>
        </table>
    </div>

    <script>
        // Función para cargar los datos de la base de datos
        function loadData() {
            fetch('http://localhost:3000/api/searches')
                .then(response => {
                    if (!response.ok) throw new Error('Error al cargar los datos.');
                    return response.json();
                })
                .then(data => {
                    const resultsBody = document.getElementById('resultsBody');
                    resultsBody.innerHTML = ''; // Limpiar la tabla

                    // Llenar la tabla con los datos
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.id}</td>
                            <td>${item.title}</td>
                            <td>${item.artistName}</td>
                            <td>${item.albumName}</td>
                            <td>${item.genreName}</td>
                            <td><a href="${item.previewUrl}" target="_blank">Vista Previa</a></td>
                            <td>${new Date(item.createdAt).toLocaleString()}</td>
                            <td>${new Date(item.updatedAt).toLocaleString()}</td>
                        `;
                        resultsBody.appendChild(row);
                    });
                })
                .catch(error => {
                    document.getElementById('message').textContent = error.message;
                });
        }

        // Cargar los datos cuando la página se carga
        window.onload = loadData;

        // Crear nuevo registro
        document.getElementById('createButton').onclick = function() {
            document.getElementById('musicId').value = ''; // Limpia el ID
            document.getElementById('artist').value = '';
            document.getElementById('genre').value = '';
            document.getElementById('year').value = '';
            document.getElementById('formContainer').style.display = 'block'; // Mostrar el formulario
        };

        // Enviar el formulario para crear o actualizar
        document.getElementById('crudForm').onsubmit = function(event) {
            event.preventDefault(); // Evitar recargar la página

            const id = document.getElementById('musicId').value;
            const artist = document.getElementById('artist').value;
            const genre = document.getElementById('genre').value;
            const year = document.getElementById('year').value;
            const method = id ? 'PUT' : 'POST'; // Si hay ID, es actualización; si no, es creación
            const url = id ? `http://localhost:3000/api/music/${id}` : 'http://localhost:3000/api/music';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    artistName: artist,
                    genre: genre,
                    releaseYear: year
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Error al guardar los cambios.');
                return response.json();
            })
            .then(data => {
                document.getElementById('message').textContent = 'Cambios guardados con éxito.';
                document.getElementById('formContainer').style.display = 'none';
                loadData(); // Volver a cargar los datos después de guardar cambios
            })
            .catch(error => {
                document.getElementById('message').textContent = error.message;
            });
        };

        // Modificar registro
        document.getElementById('updateButton').onclick = function() {
            const id = prompt('Introduce el ID del registro que deseas modificar:');
            if (id) {
                fetch(`http://localhost:3000/api/music/${id}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Registro no encontrado.');
                        return response.json();
                    })
                    .then(data => {
                        document.getElementById('musicId').value = data.id;
                        document.getElementById('artist').value = data.artistName;
                        document.getElementById('genre').value = data.genre;
                        document.getElementById('year').value = data.releaseYear;
                        document.getElementById('formContainer').style.display = 'block';
                    })
                    .catch(error => {
                        document.getElementById('message').textContent = error.message;
                    });
            }
        };

        // Eliminar registro
        document.getElementById('deleteButton').onclick = function() {
            const id = prompt('Introduce el ID del registro que deseas eliminar:');
            if (id) {
                fetch(`http://localhost:3000/api/music/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error al eliminar el registro.');
                    document.getElementById('message').textContent = 'Registro eliminado con éxito.';
                    loadData(); // Volver a cargar los datos después de eliminar
                })
                .catch(error => {
                    document.getElementById('message').textContent = error.message;
                });
            }
        };

        // Salir
        document.getElementById('exitButton').onclick = function() {
            window.location.href = 'index.html'; // Redirigir a la página principal
        };
    </script>
</body>
</html>
